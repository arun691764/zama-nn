<script>
let wallet = null;
let balances = { ZAMA:0, USDC:0 };
let logs = [];
let blockHeight = 120000;
let rate = 1.2;

const welcome = document.getElementById("welcome");
const startBtn = document.getElementById("startBtn");
const skipBtn  = document.getElementById("skipBtn");
const connectBtn = document.getElementById("connectBtn");

const walletAddrEl = document.getElementById("walletAddr");
const balancesEl   = document.getElementById("balances");

const faucetZ = document.getElementById("faucetZ");
const faucetU = document.getElementById("faucetU");
const claimIdInput = document.getElementById("claimId");

const fromToken = document.getElementById("fromToken");
const toToken   = document.getElementById("toToken");
const amountInput = document.getElementById("amount");
const swapBtn = document.getElementById("swapBtn");
const swapCountEl = document.getElementById("swapCount");
const shareApr = document.getElementById("shareApr");

const logsEl = document.getElementById("logs");
const lastTx = document.getElementById("lastTx");
const clearBtn = document.getElementById("clearBtn");

const nodesEl = document.getElementById("nodes");
const refreshNodes = document.getElementById("refreshNodes");
const blockHeightEl = document.getElementById("blockHeight");

/* --- WELCOME SCREEN FIX --- */
startBtn.onclick = () => {
  welcome.style.display = "none";
};
skipBtn.onclick = () => {
  welcome.style.display = "none";
};

/* --- WALLET CONNECT --- */
connectBtn.onclick = () => {
  if (!wallet) {
    wallet = "0x" + Math.random().toString(16).substr(2,10);
    walletAddrEl.textContent = wallet;
    connectBtn.textContent = "Disconnect";
  } else {
    wallet = null;
    walletAddrEl.textContent = "Not connected";
    connectBtn.textContent = "Connect Wallet";
  }
};

/* --- PUSH LOG --- */
function log(event) {
  logs.unshift(event);
  logsEl.textContent = logs.map(l => JSON.stringify(l, null, 2)).join("\n\n");
}

/* --- FAUCET --- */
faucetZ.onclick = () => {
  if (!wallet && !claimIdInput.value) return alert("Connect wallet or enter name/email!");

  balances.ZAMA += 100;
  balancesEl.textContent = `tZAMA: ${balances.ZAMA} â€¢ tUSDC: ${balances.USDC}`;
  log({event:"faucet", token:"tZAMA", amount:100});
};

faucetU.onclick = () => {
  if (!wallet && !claimIdInput.value) return alert("Connect wallet or enter name/email!");

  balances.USDC += 100;
  balancesEl.textContent = `tZAMA: ${balances.ZAMA} â€¢ tUSDC: ${balances.USDC}`;
  log({event:"faucet", token:"tUSDC", amount:100});
};

/* --- SWAP SYSTEM --- */
swapBtn.onclick = () => {
  if (!wallet) return alert("Connect wallet first!");

  const from = fromToken.value;
  const to = toToken.value;
  const amount = Number(amountInput.value);

  if (from === to) return alert("Cannot swap same token!");
  if (!amount) return alert("Enter amount!");

  if (balances[from] < amount) return alert("Insufficient balance!");

  let received = from === "ZAMA" ? amount * rate : amount / rate;

  balances[from] -= amount;
  balances[to] += received;

  swapCountEl.textContent = Number(swapCountEl.textContent) + 1;

  balancesEl.textContent = `tZAMA: ${balances.ZAMA} â€¢ tUSDC: ${balances.USDC}`;
  log({event:"swap", from, to, amount, received});

  if (shareApr.checked) {
    const tweet = encodeURIComponent(`I used Zama Demo Testnet! Swapped ${amount} ${from} â†’ ${received} ${to}. @AmitKum955 ðŸš€`);
    window.open("https://twitter.com/intent/tweet?text=" + tweet, "_blank");
  }

  alert(`Swapped ${amount} ${from} â†’ ${received} ${to}`);
};

/* --- CLEAR LOGS --- */
clearBtn.onclick = () => {
  logs = [];
  logsEl.textContent = "No logs yet";
};

/* --- NODES --- */
function loadNodes() {
  let html = "";
  for (let i = 1; i <= 5; i++) {
    const online = Math.random() > 0.2;
    html += `Node ${i}: <b style="color:${online ? "#4ade80" : "#f87171"}">${online ? "ONLINE" : "OFFLINE"}</b><br>`;
  }
  nodesEl.innerHTML = html;
}
refreshNodes.onclick = loadNodes;
loadNodes();

/* --- BLOCK HEIGHT --- */
setInterval(() => {
  blockHeight += 1 + Math.floor(Math.random()*2);
  blockHeightEl.textContent = blockHeight;
}, 1500);
</script>
