<script>
/* ---------------------------
   FULL FIXED TESTNET ENGINE
---------------------------*/

let wallet = null;
let balances = { ZAMA: 0, USDC: 0 };
let logs = [];
let blockHeight = 120000;
let rate = 1.2;

// Elements
const walletAddrEl = document.getElementById("walletAddr");
const balancesEl   = document.getElementById("balances");

const faucetZ = document.getElementById("faucetZ");
const faucetU = document.getElementById("faucetU");

const fromToken = document.getElementById("fromToken");
const toToken   = document.getElementById("toToken");

const amountInput   = document.getElementById("amount");
const swapBtn       = document.getElementById("swapBtn");
const swapCountEl   = document.getElementById("swapCount");
const shareAprCheck = document.getElementById("shareApr");

const logsEl  = document.getElementById("logs");
const lastTx  = document.getElementById("lastTx");
const clearBtn = document.getElementById("clearBtn");

const nodesEl = document.getElementById("nodes");
const refreshNodes = document.getElementById("refreshNodes");

const blockHeightEl = document.getElementById("blockHeight");

const startBtn = document.getElementById("startBtn");
const skipBtn  = document.getElementById("skipBtn");
const welcome  = document.getElementById("welcome");

const claimIdInput = document.getElementById("claimId");


// ------------------------
// LOG SYSTEM
// ------------------------
function pushLog(obj){
    obj.time = new Date().toLocaleTimeString();
    logs.unshift(obj);
    logsEl.textContent = logs.map(l => JSON.stringify(l,null,2)).join("\n\n");
}


// ------------------------
// CONNECT WALLET
// ------------------------
document.getElementById("connectBtn").addEventListener("click", ()=> {
    if(!wallet){
        wallet = "0x" + Math.random().toString(16).substr(2,10);
        walletAddrEl.textContent = wallet;
        pushLog({ event:"wallet_connected", wallet });
    } else {
        wallet = null;
        walletAddrEl.textContent = "Not connected";
        pushLog({ event:"wallet_disconnected" });
    }
});


// ------------------------
// FAUCET
// ------------------------
function giveTokens(token){
    if(!wallet){
        alert("Connect wallet first");
        return;
    }

    balances[token] += 100;

    balancesEl.textContent = `tZAMA: ${balances.ZAMA} • tUSDC: ${balances.USDC}`;

    pushLog({event:"faucet_claim", token, amount:100});
}

faucetZ.onclick = ()=> giveTokens("ZAMA");
faucetU.onclick = ()=> giveTokens("USDC");


// ------------------------
// SWAP SYSTEM
// ------------------------
let swapCount = 0;

swapBtn.addEventListener("click", ()=> {
    if(!wallet){
        alert("Connect wallet first");
        return;
    }

    const from = fromToken.value;
    const to   = toToken.value;
    const amount = parseFloat(amountInput.value);

    if(from === to){
        alert("Select different tokens");
        return;
    }
    if(!amount || amount <= 0){
        alert("Enter valid amount");
        return;
    }
    if(balances[from] < amount){
        alert("Not enough balance");
        return;
    }

    const fee = 0.005;
    let received;

    if(from === "ZAMA"){
        received = amount * rate * (1 - fee);
    } else {
        received = (amount / rate) * (1 - fee);
    }

    received = Number(received.toFixed(4));

    balances[from] -= amount;
    balances[to]   += received;

    balancesEl.textContent = `tZAMA: ${balances.ZAMA} • tUSDC: ${balances.USDC}`;

    const tx = "0x" + Math.random().toString(16).substr(2,10);

    pushLog({event:"swap", from, to, amount, received, tx});
    lastTx.textContent = "Last TX: " + tx;

    swapCount++;
    swapCountEl.textContent = swapCount;

    if(shareAprCheck.checked){
        const msg = encodeURIComponent(
            `Tried Zama Demo Testnet! Swapped ${amount} ${from} → ${received} ${to}. APR 12.5%. Learn more: https://docs.zama.org/protocol • @AmitKum955`
        );
        window.open(`https://twitter.com/intent/tweet?text=${msg}`,"_blank");
    }

    alert(`Swap Successful! TX: ${tx}`);
});


// ------------------------
// MPC NODES
// ------------------------
function loadNodes(){
    let html = "";
    for(let i=1;i<=5;i++){
        const online = Math.random() > 0.2;
        html += `Node ${i}: <b style="color:${online?'#00ff88':'#ff4444'}">${online?"ONLINE":"OFFLINE"}</b><br>`;
    }
    nodesEl.innerHTML = html;
}
refreshNodes.onclick = loadNodes;


// ------------------------
// BLOCK HEIGHT SIMULATION
// ------------------------
setInterval(()=> {
    blockHeight += Math.floor(Math.random()*3);
    blockHeightEl.textContent = blockHeight;
},1500);


// ------------------------
// CLEAR LOGS
// ------------------------
clearBtn.onclick = ()=> {
    logs = [];
    logsEl.textContent = "No logs yet";
};


// ------------------------
// WELCOME SCREEN FIX
// ------------------------
startBtn.onclick = ()=> {
    welcome.style.display = "none";
};
skipBtn.onclick = ()=> {
    welcome.style.display = "none";
};

loadNodes();
</script>
